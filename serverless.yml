service: plankton-auth


package:
  exclude: 
    - data/**
    - .vscode/**
    - .idea/**
    - README.md
    - bin
    - bitbucket-pipelines.yml
    - .eslintrc
    - jest-dynalite-config.js
    - jest.config.json
  individually: true

custom:
  stage: ${opt:stage, 'staging'}
  region: 'sa-east-1'
  serverless-offline:
    httpPort: 3000
    noPrependStageInUrl: true
  esbuild:
    bundle: true
    sourcemap: true
    minify: false
    packager: yarn
    watch:
      pattern: 'src/**/*.ts'
      ignore: '**/*.test.ts'
  swaggerApi:
    swagger: ${file(docs/swagger.yaml)}
  customDomain:
    domainName: auth.api.planktondoc.com
    stage: ${self:custom.stage}
    basePath: ${self:custom.stage}
    certificateName: 'planktondoc.com'
    createRoute53Record: true
    createRoute53IPv6Record: true
    endpointType: REGIONAL
    securityPolicy: tls_1_2
    apiType: rest
    autoDomain: true
  staging:
    stage: staging
    logRetentionInDays: 5
    userPool: plankton-pool-staging
    userClient: plankton-client-staging
    secretGitHubId: plankton-staging/github
  production:
    stage: production
    logRetentionInDays: 60
    userPool: plankton-pool-production
    userClient: plankton-client-production
    secretGitHubId: plankton-production/github

provider:
  name: aws
  runtime: nodejs16.x
  versionFunctions: false
  stage: ${self:custom.stage}
  region: 'sa-east-1'
  endpointType: REGIONAL
  environment:
    REGION: ${self:custom.region}
    STAGE: ${self:custom.${self:custom.stage}.stage}
    NODE_OPTIONS: --enable-source-maps
    USER_POOL_ID: { Ref: UserPool }
    USER_CLIENT_ID: { Ref: UserClient }
    GITHUB_API_URL: https://api.github.com
    GITHUB_LOGIN_URL: https://github.com
    SECRET_GITHUB_ID: ${self:custom.${self:custom.stage}.secretGitHubId}
    COGNITO_REDIRECT_URI: https://plankton.auth.sa-east-1.amazoncognito.com/oauth2/idpresponse # change for custom domain
  deploymentBucket:
    name: serverless.tag.deployment

functions:
  signIn:
    handler: src/functions/signIn.handler
    iamRoleStatements:
      - Effect: Allow
        Action:
          - cognito-idp:InitiateAuth
        Resource:
          - arn:aws:secretsmanager:sa-east-1:174628554481:secret:plankton-${self:custom.stage}/github-*
  signUp:
    handler: src/functions/signUp.handler
    iamRoleStatements:
      - Effect: Allow
        Action:
          - cognito-idp:SignUp
        Resource:
          - arn:aws:secretsmanager:sa-east-1:174628554481:secret:plankton-${self:custom.stage}/github-*
  githubAuthorize:
    handler: src/functions/github/authorizer.handler
  githubToken:
    handler: src/functions/github/token.handler
    iamRoleStatements:
      - Effect: Allow
        Action:
          - secretsmanager:GetSecretValue
        Resource:
          - arn:aws:secretsmanager:sa-east-1:174628554481:secret:plankton-${self:custom.stage}/github-*
  githubUser:
    handler: src/functions/github/userInfo.handler
  githubJwks:
    handler: src/functions/github/jwks.handler
    iamRoleStatements:
      - Effect: Allow
        Action:
          - secretsmanager:GetSecretValue
        Resource:
          - arn:aws:secretsmanager:sa-east-1:174628554481:secret:plankton-${self:custom.stage}/github-*

resources:
  Resources:
    UserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: ${self:custom.${self:custom.stage}.userPool}
        Schema:
          - Name: email
            Required: true
            Mutable: true
        Policies:
          PasswordPolicy:
            MinimumLength: 6
        AutoVerifiedAttributes: ["email"]

    UserClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        ClientName: ${self:custom.${self:custom.stage}.userClient}
        GenerateSecret: false
        UserPoolId: { Ref: UserPool }
        AccessTokenValidity: 5
        IdTokenValidity: 5

plugins:
  - serverless-esbuild
  - serverless-offline
  - serverless-plugin-swagger-api
  - serverless-plugin-log-retention
  - serverless-iam-roles-per-function
  - serverless-domain-manager